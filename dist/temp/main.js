function draw(t,e){var i=0,n=0;e.level&&(i=e.level.level.map.pos.x,n=e.level.level.map.pos.y),t.drawImage(e.sprite.image,0,0,e.aabb.width,e.aabb.height,e.pos.x*e.sprite.image.width+i,e.pos.y*e.sprite.image.height+n,e.aabb.width,e.aabb.height),e.sprite.redraw=!1,t.mozImageSmoothingEnabled=!1,t.imageSmoothingEnabled=!1}function input(t){Input.Keyboard.wasDown(Input.Keyboard.KEY.D)&&(t.movement.x=1),Input.Keyboard.wasDown(Input.Keyboard.KEY.A)&&(t.movement.x=-1),Input.Keyboard.wasDown(Input.Keyboard.KEY.W)&&(t.movement.y=-1),Input.Keyboard.wasDown(Input.Keyboard.KEY.S)&&(t.movement.y=1)}function collision(t){if(t.level){var e=t.level.level.map.getTile(t.pos.x+t.movement.x,t.pos.y+t.movement.y);if(e&&e.walkable){for(var i=!1,n=0,s=t.level.level.entities;n<s.length;n++){var o=s[n];if(i=i||o.pos.x==t.pos.x+t.movement.x&&o.pos.y==t.pos.y+t.movement.y)break}i&&(t.movement.x=0,t.movement.y=0)}else t.movement.x=0,t.movement.y=0}}function combat(t){t.combat&&t.combat.target}function AIMovement(t){t.aihero&&t.aihero.movementCooldown<=0&&(t.aihero.movementCooldown+=500,t.movement&&(0===(2*Math.random()|0)?t.movement.x=0===(2*Math.random()|0)?-1:1:t.movement.y=0===(2*Math.random()|0)?-1:1)),t.AIPath&&t.AIPath.ready}function movement(t){!t.movement||0==t.movement.x&&0==t.movement.y||(t.pos.x+=t.movement.x,t.pos.y+=t.movement.y,t.movement.x=t.movement.y=0,t.sprite.redraw=!0)}function movementSound(t){t.audio&&t.movement&&(0!=t.movement.x||0!=t.movement.y)&&t.audio.sound.play()}function onResize(){var t=document.getElementById("gameCanvas"),e=window.innerWidth/t.width,i=window.innerHeight/t.height,n=0|Math.min(e,i);n=0>=n?1:n;var s=[t.width*n,t.height*n],o=this.offset=[(window.innerWidth-s[0])/2,(window.innerHeight-s[1])/2],h=document.getElementById("stage"),a="translate("+o[0]+"px, "+o[1]+"px) scale("+n+")";h.style.transform=a,h.style.webkitTransform=a}var Input;!function(t){var e;!function(t){function e(t){return o[t]}function i(t){var e=a[t];return a[t]=!1,e}function n(t){var e=t.which;o[e]=!0,h[e]&&(a[e]=!0),h[e]=!1}function s(t){var e=t.which;o[e]=!1,h[e]=!0}!function(t){t[t.A=65]="A",t[t.D=68]="D",t[t.W=87]="W",t[t.S=83]="S",t[t.ENTER=13]="ENTER",t[t.SPACE=32]="SPACE"}(t.KEY||(t.KEY={}));for(var o=(t.KEY,[]),h=[],a=[],r=0;256>r;r++)h[r]=!0;t.isDown=e,t.wasDown=i,t.keyDown=n,t.keyUp=s}(e=t.Keyboard||(t.Keyboard={}))}(Input||(Input={}));var Point=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t.from=function(e,i){return new t(e,i)},t}(),Dimension=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.width=t,this.height=e}return t.from=function(e,i){return new t(e,i)},t}(),Tile=function(){function t(t){this.texture=t,this.size=new Dimension(t.width,t.height)}return t.prototype.draw=function(t,e,i){t.drawImage(this.texture,0,0,this.size.width,this.size.height,e,i,this.size.width,this.size.height)},t}(),SpriteSheet=function(){function t(t,e,i,n,s,o){void 0===n&&(n=0),void 0===s&&(s=new Dimension(0,0)),void 0===o&&(o=new Point(0,0)),this.sprites=[],this.name=e,this.offset=o,this.ss=s,this.ts=i,this.gutter=n,this.image=ImageCache.getTexture(t),this.storeSprites()}return t.prototype.storeSprites=function(t){void 0===t&&(t=null),this.spritesPerRow=0===this.ss.width||0===this.ss.height?this.image.width/this.ts:this.ss.width,this.spritesPerCol=0===this.ss.width||0===this.ss.height?this.image.height/this.ts:this.ss.height;for(var e,i=0;i<this.spritesPerCol;i++)for(var n=0;n<this.spritesPerRow;n++)e=this.sprites[n+i*this.spritesPerRow]=document.createElement("canvas"),e.width=this.ts,e.height=this.ts,e.getContext("2d").drawImage(this.image,(this.ts+this.gutter)*n+this.offset.x,(this.ts+this.gutter)*i+this.offset.y,this.ts,this.ts,0,0,this.ts,this.ts)},t}(),SpriteSheetCache;!function(t){function e(t){n[t.name]=t}function i(t){return n[t]}var n={};t.storeSheet=e,t.spriteSheet=i}(SpriteSheetCache||(SpriteSheetCache={}));var ImageCache;!function(t){function e(t){return i[t]}var i={};t.getTexture=e;var n,s={},o=0;!function(t){function e(t,e){s[t]=e,o++}function n(t){var e={counter:0,loadCount:0,callback:t},n=function(t){t.counter++===t.loadCount&&t.callback()};for(var h in s)i[h]=new Image,i[h].src=s[h],i[h].onload=n.bind(this,e),delete s[h];o=0}t.add=e,t.load=n}(n=t.Loader||(t.Loader={}))}(ImageCache||(ImageCache={}));var AudioPool=function(){function t(t,e){void 0===e&&(e=1),this.pool=[],this.index=0,this.maxSize=e;for(var i=0;i<this.maxSize;i++)this.pool[i]=new Audio(t),this.pool[i].load()}return t.prototype.play=function(){(0==this.pool[this.index].currentTime||this.pool[this.index].ended)&&this.pool[this.index].play(),this.index=(this.index+1)%this.maxSize},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);i.prototype=e.prototype,t.prototype=new i},VTile=function(t){function e(e,i){void 0===i&&(i=!1),t.call(this,e),this.walkable=i}return __extends(e,t),e}(Tile),TileSet=function(){function t(t){this.tiles=[],this.ts=t.ts;for(var e=0;e<t.sprites.length;e++)this.tiles.push(new VTile(t.sprites[e]));this.tiles[0].walkable=!0}return t}(),TileMap=function(){function t(t,e){void 0===t&&(t=new Dimension(1,1)),void 0===e&&(e=new Point(0,0)),this.cached=!1,this.size=t,this.pos=e,this.tiles=[],this.cache=document.createElement("canvas")}return t.prototype.setTile=function(t,e,i){this.tiles[t+e*this.size.width]=i},t.prototype.getTile=function(t,e){if(t==this.size.width||0>t||e==this.size.height||0>e)return void 0;var i=this.tiles[t+e*this.size.width];return new MetaTile(this.tileSet.tiles[i],t,e,i)},t.prototype.setTileSet=function(t){this.tileSet=t},t.prototype.draw=function(t){var e=t;if(!this.cached){this.cache.width=8*this.size.width,this.cache.height=8*this.size.height,t=this.cache.getContext("2d");for(var i=0;i<this.size.height;i++)for(var n=0;n<this.size.width;n++)this.getTile(n,i).draw(t,8*n,8*i);this.cached=!0}e.drawImage(this.cache,this.pos.x,this.pos.y)},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);i.prototype=e.prototype,t.prototype=new i},MetaTile=function(t){function e(e,i,n,s){t.call(this,e.texture,e.walkable),this.value=s,this.x=i,this.y=n,this.xd=0,this.yd=0}return __extends(e,t),e}(VTile),Level=function(){function t(e){void 0===e&&(e=new TileMap(Dimension.from(25,25),Point.from(8,32))),this.map=e,this.map.setTileSet(t.defaultTileSet),this.generateLevel(),this.entities=[]}return t.prototype.getWall=function(t,e,i,n){var s=this.map.getTile(i,n);return s&&1===s.value?(s.xd=i-t,s.yd=n-e,s):void 0},t.prototype.getWalls=function(t,e){var i=[],n=this.getWall(t,e,t,e-1);n&&i.push(n);var s=this.getWall(t,e,t,e+1);s&&i.push(s);var o=this.getWall(t,e,t-1,e);o&&i.push(o);var h=this.getWall(t,e,t+1,e);return h&&i.push(h),i},t.prototype.generateLevel=function(){for(var t=0;t<this.map.size.width*this.map.size.height;t++)this.map.tiles[t]=1;for(var t=0;t<this.map.size.width;t++)this.map.tiles[t]=this.map.tiles[this.map.tiles.length-1-t]=2;for(var t=1;t<this.map.size.height-1;t++)this.map.tiles[this.map.size.width*t]=this.map.tiles[this.map.size.width*(t+1)-1]=2;var e=Point.from(1,1),i=this.map.getTile(e.x,e.y);i.value=0,this.map.setTile(i.x,i.y,0);var n=[];do{i&&(n=n.concat(this.getWalls(i.x,i.y)));var s=Math.random()*n.length|0,o=n[s],h=this.map.getTile(o.x+o.xd,o.y+o.yd);h&&1===h.value?(h.value=0,this.map.setTile(h.x,h.y,0),o.value=0,this.map.setTile(o.x,o.y,0),i=this.map.getTile(h.x,h.y)):(o.value=3,this.map.setTile(o.x,o.y,3),i=void 0),n=n.filter(function(t,e,i){return 1===t.value})}while(0!=n.length)},t}(),Entity=function(){function t(){this._count=0,this.components={},this.id=t.autoID++}return t.prototype.add=function(t){this.components[t.name]||this._count++,this.components[t.name]=t,this[t.name]=this.components[t.name]},t.autoID=0,t}(),PositionC=function(){function t(t,e){this.name="pos",this.x=t,this.y=e}return t}(),AABBC=function(){function t(t,e){this.name="aabb",this.width=t,this.height=e}return t}(),SpriteC=function(){function t(t){this.name="sprite",this.redraw=!0,this.image=t}return t}(),LevelC=function(){function t(t){this.name="level",this.level=t}return t}(),LayerC=function(){function t(t){void 0===t&&(t=0),this.name="layer",this.layer=t}return t}(),AudioC=function(){function t(t){this.name="audio",this.sound=new AudioPool(t,3)}return t}(),MovementC=function(){function t(){this.name="movement",this.x=0,this.y=0}return t}(),PlayerC=function(){function t(){this.name="player",this.value=!0}return t}(),InputC=function(){function t(){this.name="input",this.value=!0}return t}(),AIHeroC=function(){function t(){this.name="aihero",this.movementCooldown=500,this.value=!0}return t}(),Game=function(){function t(t){this.entities=[],this.state="MainMenu",this.change=!0,this.clearScreen=!0,this.then=performance.now(),console.log("Setting up screen"),this.screen=t,this.ctx=t.getContext("2d"),this.ctx.mozImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1}return t.prototype.init=function(){console.log("Initializing..."),SpriteSheetCache.storeSheet(new SpriteSheet("sheet","pieces",8,0,new Dimension(10,1))),SpriteSheetCache.storeSheet(new SpriteSheet("sheet","board",8,0,new Dimension(10,1),new Point(0,8))),SpriteSheetCache.storeSheet(new SpriteSheet("sheet","numbers",8,0,new Dimension(10,1),new Point(0,16))),Level.defaultTileSet=new TileSet(SpriteSheetCache.spriteSheet("board")),this.World=new Level;var t=this.pEntity=new Entity;t.add(new InputC),t.add(new MovementC),t.add(new AudioC("boop3.wav")),t.add(new LevelC(this.World)),t.add(new PositionC(1,1)),t.add(new AABBC(8,8)),t.add(new SpriteC(SpriteSheetCache.spriteSheet("pieces").sprites[0])),this.pEntity=t,this.World.entities.push(this.pEntity);var t=this.hEntity=new Entity;t.add(new PositionC(1,this.World.map.size.height-2)),t.add(new MovementC),t.add(new LevelC(this.World)),t.add(new AABBC(8,8)),t.add(new SpriteC(SpriteSheetCache.spriteSheet("pieces").sprites[1])),t.add(new AIHeroC),this.hEntity=t,this.World.entities.push(t)},t.prototype.update=function(t){switch(this.state){case"MainMenu":this.state="GameMaze";break;case"GameMaze":this.hEntity.aihero.movementCooldown-=t,AIMovement(this.hEntity),(0!=this.hEntity.movement.x||0!=this.hEntity.movement.y)&&collision(this.hEntity),movement(this.hEntity),input(this.pEntity),(0!=this.pEntity.movement.x||0!=this.pEntity.movement.y)&&collision(this.pEntity),movementSound(this.pEntity),movement(this.pEntity);break;case"GameMenu":break;case"GameOver":this.state="MainMenu"}},t.prototype.draw=function(){switch(this.state){case"MainMenu":break;case"GameMaze":case"GameMenu":this.clearScreen&&(this.ctx.clearRect(0,0,this.screen.width,this.screen.height),this.clearScreen=!1);for(var t=0,e=this.entities;t<e.length;t++){var i=e[t];i.sprite.redraw&&draw(this.ctx,i)}if(this.pEntity.sprite.redraw||this.hEntity.sprite.redraw||this.change){this.World.map.draw(this.ctx),draw(this.ctx,this.pEntity);for(var n=0,s=this.World.entities;n<s.length;n++){var i=s[n];draw(this.ctx,i)}this.change=!1}break;case"GameOver":}},t.prototype.render=function(){var t=performance.now(),e=t-this.then;this.then=t,this.update(e),this.draw(),this._loopHandle=window.requestAnimationFrame(this.render.bind(this))},t.prototype.run=function(){console.log("Game running"),this._loopHandle=window.requestAnimationFrame(this.render.bind(this))},t.prototype.stop=function(){console.log("Game stopped"),window.cancelAnimationFrame(this._loopHandle)},t}();window.onload=function(){onResize(),window.addEventListener("resize",onResize,!1),window.onkeydown=Input.Keyboard.keyDown,window.onkeyup=Input.Keyboard.keyUp;var t=new Game(document.getElementById("gameCanvas"));ImageCache.Loader.add("sheet","sheet.png"),ImageCache.Loader.load(function(){t.init(),t.run()})};