function getRandomInt(t,e){return void 0===t&&(t=0),void 0===e&&(e=1),(Math.random()*(e-t+1)|0)+t}function draw(t,e){if(e.sprite){var i=0,n=0;e.level&&(i=e.level.level.map.pos.x,n=e.level.level.map.pos.y),e.sprite.visable===!0&&t.drawImage(e.sprite.image,0,0,e.aabb.w,e.aabb.h,e.pos.x*e.sprite.image.width+i,e.pos.y*e.sprite.image.height+n,e.aabb.w,e.aabb.h),e.sprite.redraw=!1}}function input(t,e){if(t.input){for(var i in t.input.cooldowns)t.input.cooldowns[i]-=e;t.mv&&((Input.KB.isDown(Input.KB.KEY.D)||Input.KB.isDown(Input.KB.KEY.RIGHT))&&t.input.cooldowns[0]<=0&&(t.input.cooldowns[0]=166,t.mv.x=1),(Input.KB.isDown(Input.KB.KEY.A)||Input.KB.isDown(Input.KB.KEY.LEFT))&&t.input.cooldowns[1]<=0&&(t.input.cooldowns[1]=166,t.mv.x=-1),(Input.KB.isDown(Input.KB.KEY.W)||Input.KB.isDown(Input.KB.KEY.UP))&&t.input.cooldowns[2]<=0&&(t.input.cooldowns[2]=166,t.mv.y=-1),(Input.KB.isDown(Input.KB.KEY.S)||Input.KB.isDown(Input.KB.KEY.DOWN))&&t.input.cooldowns[3]<=0&&(t.input.cooldowns[3]=166,t.mv.y=1),t.input.enabled===!1&&(t.mv.x=t.mv.y=0)),t.player&&Input.KB.wasDown(Input.KB.KEY.SPACE)&&t.player&&t.haunt&&(t.haunt.haunting=!t.haunt.haunting)}}function haunt(t){if(t.haunt&&t.level)if(t.haunt.haunting&&!t.haunt.haunted){for(var e=!1,i=0,n=t.level.level.entities;i<n.length;i++){var s=n[i];s.player||s.aihero||s.boss||!s.pos||!t.pos||s.pos.x!==t.pos.x||s.pos.y!==t.pos.y||(t.haunt.haunted=s,s.input.enabled=t.sprite.redraw=e=!0,t.input.enabled=t.sprite.visable=!1)}e||(t.haunt.haunting=!1)}else!t.haunt.haunting&&t.haunt.haunted?(t.pos.x=t.haunt.haunted.pos.x,t.pos.y=t.haunt.haunted.pos.y,t.haunt.haunted.input.enabled=t.haunt.haunting=!1,t.input.enabled=t.sprite.visable=t.sprite.redraw=!0,t.haunt.haunted=void 0):t.haunt.haunting&&t.haunt.haunted&&t.haunt.haunted.combat&&!t.haunt.haunted.combat.alive&&(t.haunt.haunting=!1)}function collision(t){if(t.level&&t.collision){var e=t.level.level.map.getTile(t.pos.x+t.mv.x,t.pos.y+t.mv.y);if(t.collision.type===CollisionTypes.WORLD)e&&2!==e.value||(t.mv.x=0,t.mv.y=0);else if(t.collision.type===CollisionTypes.WORLD||e&&e.walkable){if(t.collision.type===CollisionTypes.ENTITY){for(var i,n=!1,s=0,o=t.level.level.entities;s<o.length;s++){var a=o[s];if(n=n||a.pos.x==t.pos.x+t.mv.x&&a.pos.y==t.pos.y+t.mv.y&&a.collision&&a.collision.type===CollisionTypes.ENTITY){i=a;break}}n&&(t.mv.x=0,t.mv.y=0,t.combat&&(t.combat.target=i,console.log(t.combat.target)))}}else t.mv.x=0,t.mv.y=0}}function combat(t){if(t.aihero&&t.combat)if(t.combat.target&&t.combat.target.combat){var e=t.combat.target;e.combat.alive?(e.combat.alive=!1,e.sprite.visable=!1,e.sprite.redraw=!0,e.collision.type=CollisionTypes.WORLD):t.combat.target=void 0}else t.combat.target=void 0}function AIMovement(t,e){if(t.aihero){if(t.aihero.movementCooldown-=e,t.combat&&t.combat.target)return;t.aihero.movementCooldown<=0&&(t.aihero.movementCooldown+=2e3,t.aihero.AIPath.length>0&&(void 0===t.aihero.nextMove&&(t.aihero.nextMove=t.aihero.AIPath.pop()),t.mv.x=t.aihero.nextMove.x,t.mv.y=t.aihero.nextMove.y))}}function movement(t){!t.mv||0==t.mv.x&&0==t.mv.y||(t.pos.x+=t.mv.x,t.pos.y+=t.mv.y,t.mv.x=t.mv.y=0,t.aihero&&(t.aihero.nextMove=void 0),t.sprite.redraw=!0)}function movementSound(t){t.audio&&t.mv&&(0!=t.mv.x||0!=t.mv.y)&&t.audio.sound.play()}function onResize(){var t=document.getElementById("gameCanvas"),e=window.innerWidth/t.width,i=window.innerHeight/t.height,n=0|Math.min(e,i);n=0>=n?1:n;var s=[t.width*n,t.height*n],o=this.offset=[(window.innerWidth-s[0])/2,(window.innerHeight-s[1])/2],a=document.getElementById("stage"),h="translate("+o[0]+"px, "+o[1]+"px) scale("+n+")";a.style.transform=h,a.style.webkitTransform=h}var Input;!function(t){var e;!function(t){function e(t){return o[t]}function i(t){var e=h[t];return h[t]=!1,e}function n(t){var e=t.which;o[e]=!0,a[e]&&(h[e]=!0),a[e]=!1}function s(t){var e=t.which;o[e]=!1,a[e]=!0}!function(t){t[t.A=65]="A",t[t.D=68]="D",t[t.W=87]="W",t[t.S=83]="S",t[t.LEFT=37]="LEFT",t[t.RIGHT=39]="RIGHT",t[t.UP=38]="UP",t[t.DOWN=40]="DOWN",t[t.ENTER=13]="ENTER",t[t.SPACE=32]="SPACE"}(t.KEY||(t.KEY={}));for(var o=(t.KEY,[]),a=[],h=[],r=0;256>r;r++)a[r]=!0;t.isDown=e,t.wasDown=i,t.keyDown=n,t.keyUp=s}(e=t.KB||(t.KB={}))}(Input||(Input={}));var Pt=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t.from=function(e,i){return new t(e,i)},t}(),Dm=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.width=t,this.height=e}return t.from=function(e,i){return new t(e,i)},t}(),Tile=function(){function t(t){this.texture=t,this.size=new Dm(t.width,t.height)}return t.prototype.draw=function(t,e,i){t.drawImage(this.texture,0,0,this.size.width,this.size.height,e,i,this.size.width,this.size.height)},t}(),SpriteSheet=function(){function t(t,e,i,n,s,o){void 0===n&&(n=0),void 0===s&&(s=new Dm(0,0)),void 0===o&&(o=new Pt(0,0)),this.sprites=[],this.name=e,this.offset=o,this.ss=s,this.ts=i,this.gutter=n,this.image=ImageCache.getTexture(t),this.storeSprites()}return t.prototype.storeSprites=function(t){void 0===t&&(t=null),this.spritesPerRow=0===this.ss.width||0===this.ss.height?this.image.width/this.ts:this.ss.width,this.spritesPerCol=0===this.ss.width||0===this.ss.height?this.image.height/this.ts:this.ss.height;for(var e,i=0;i<this.spritesPerCol;i++)for(var n=0;n<this.spritesPerRow;n++)e=this.sprites[n+i*this.spritesPerRow]=document.createElement("canvas"),e.width=this.ts,e.height=this.ts,e.getContext("2d").drawImage(this.image,(this.ts+this.gutter)*n+this.offset.x,(this.ts+this.gutter)*i+this.offset.y,this.ts,this.ts,0,0,this.ts,this.ts)},t}(),SSC;!function(t){function e(t){n[t.name]=t}function i(t){return n[t]}var n={};t.storeSheet=e,t.spriteSheet=i}(SSC||(SSC={}));var ImageCache;!function(t){function e(t){return i[t]}var i={};t.getTexture=e;var n,s={},o=0;!function(t){function e(t,e){s[t]=e,o++}function n(t){var e={counter:0,loadCount:0,callback:t},n=function(t){t.counter++===t.loadCount&&t.callback()};for(var a in s)i[a]=new Image,i[a].src=s[a],i[a].onload=n.bind(this,e),delete s[a];o=0}t.add=e,t.load=n}(n=t.Loader||(t.Loader={}))}(ImageCache||(ImageCache={}));var AudioPool=function(){function t(t,e){void 0===e&&(e=1),this.pool=[],this.index=0,this.maxSize=e;for(var i=0;i<this.maxSize;i++)this.pool[i]=new Audio(t),this.pool[i].load()}return t.prototype.play=function(){(0==this.pool[this.index].currentTime||this.pool[this.index].ended)&&this.pool[this.index].play(),this.index=(this.index+1)%this.maxSize},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);i.prototype=e.prototype,t.prototype=new i},VTile=function(t){function e(e,i){void 0===i&&(i=!1),t.call(this,e),this.walkable=i}return __extends(e,t),e}(Tile),TileSet=function(){function t(t){this.tiles=[],this.ts=t.ts;for(var e=0;e<t.sprites.length;e++)this.tiles.push(new VTile(t.sprites[e]));this.tiles[0].walkable=!0}return t}(),TileMap=function(){function t(t,e){void 0===t&&(t=new Dm(1,1)),void 0===e&&(e=new Pt(0,0)),this.cached=!1,this.size=t,this.pos=e,this.tiles=[],this.cache=document.createElement("canvas")}return t.prototype.setTile=function(t,e,i){this.tiles[t+e*this.size.width]=i},t.prototype.getTile=function(t,e){if(t==this.size.width||0>t||e==this.size.height||0>e)return void 0;var i=this.tiles[t+e*this.size.width];return new MetaTile(this.tileSet.tiles[i],t,e,i)},t.prototype.setTileSet=function(t){this.tileSet=t},t.prototype.draw=function(t){var e=t;if(!this.cached){this.cache.width=8*this.size.width,this.cache.height=8*this.size.height,t=this.cache.getContext("2d");for(var i=0;i<this.size.height;i++)for(var n=0;n<this.size.width;n++)this.getTile(n,i).draw(t,8*n,8*i);this.cached=!0}e.drawImage(this.cache,this.pos.x,this.pos.y)},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);i.prototype=e.prototype,t.prototype=new i},MetaTile=function(t){function e(e,i,n,s){t.call(this,e.texture,e.walkable),this.FVal=0,this.GVal=0,this.HVal=0,this.value=s,this.x=i,this.y=n,this.xd=0,this.yd=0}return __extends(e,t),e}(VTile),Level=function(){function t(e){void 0===e&&(e=new TileMap(Dm.from(25,25),Pt.from(8,32))),this.eSpawns=[],this.AIPath=[],this.map=e,this.map.setTileSet(t.defaultTileSet);do this.eSpawns=[],this.generateLevel(),this.AIPath=this.generatePath(1,23,23,1);while(this.AIPath.length<50);this.setSpawns(),this.entities=[]}return t.prototype.getNbr=function(t,e,i,n,s){var o=this.map.getTile(i,n);return o&&o.value===s?(o.xd=i-t,o.yd=n-e,o):void 0},t.prototype.getNbrs=function(t,e,i){var n=[],s=this.getNbr(t,e,t,e-1,i);s&&n.push(s);var o=this.getNbr(t,e,t,e+1,i);o&&n.push(o);var a=this.getNbr(t,e,t-1,e,i);a&&n.push(a);var h=this.getNbr(t,e,t+1,e,i);return h&&n.push(h),n},t.prototype.generateLevel=function(){for(var t=0;t<this.map.size.width*this.map.size.height;t++)this.map.tiles[t]=1;for(var t=0;t<this.map.size.width;t++)this.map.tiles[t]=this.map.tiles[this.map.tiles.length-1-t]=2;for(var t=1;t<this.map.size.height-1;t++)this.map.tiles[this.map.size.width*t]=this.map.tiles[this.map.size.width*(t+1)-1]=2;var e=Pt.from(getRandomInt(1,23),getRandomInt(1,23));e.x%2==0&&(e.x-=1),e.y%2==0&&(e.y-=1);var i=this.map.getTile(e.x,e.y);i.value=0,this.map.setTile(i.x,i.y,0);var n=[];do{i&&(n=n.concat(this.getNbrs(i.x,i.y,1)));var s=getRandomInt(0,n.length-1),o=n[s],a=this.map.getTile(o.x+o.xd,o.y+o.yd);a&&1===a.value?(a.value=0,this.map.setTile(a.x,a.y,0),o.value=0,this.map.setTile(o.x,o.y,0),i=this.map.getTile(a.x,a.y)):(o.value=3,this.map.setTile(o.x,o.y,3),i=void 0),n=n.filter(function(t,e,i){return 1===t.value})}while(0!=n.length)},t.prototype.generatePath=function(t,e,i,n){var s,o,a,h=[],r=[],l=[],u=[];for(r.push(this.map.getTile(t,e));;){if(s=r.pop(),l.push(s),s.x===i&&s.y===n){o=s;break}u=this.getNbrs(s.x,s.y,0);for(var p=0;p<u.length;p++){var d=u[p];if(!this.tileInSet(d.x,d.y,l)){var c=this.getTileInSet(d.x,d.y,r);if(void 0===c)d.parent=s,d.HVal=Math.abs(i-d.x)+Math.abs(n-d.y),d.GVal=s.GVal+10,d.FVal=d.HVal+d.GVal,r.push(d);else{var m=s.GVal+10;m<c.GVal&&(c.parent=s,c.GVal=s.GVal+10,c.FVal=c.HVal+c.GVal)}}}if(0===r.length)break;r.sort(function(t,e){return e.FVal-t.FVal})}do a=o.parent,h.push(Pt.from(o.x-a.x,o.y-a.y)),o=a,o.x!=t&&o.y!=e&&this.eSpawns.push(Pt.from(o.x,o.y));while(void 0!==o.parent);return h},t.prototype.getTileInSet=function(t,e,i){for(var n=void 0,s=0;s<i.length;s++){var o=i[s];if(o.x===t&&o.y===e){n=o;break}}return n},t.prototype.tileInSet=function(t,e,i){for(var n=!1,s=0;s<i.length;s++){var o=i[s];if(n=n||o.x===t&&o.y===e,n===!0)break}return n},t.prototype.setSpawns=function(){for(var t=2;22>=t;t++)for(var e=2;22>=e;e++){var i=this.map.getTile(e,t);0===i.value}},t}(),Entity=function(){function t(){this._count=0,this.components={},this.id=t.autoID++}return t.prototype.add=function(t){this.components[t.name]||this._count++,this.components[t.name]=t,this[t.name]=this.components[t.name]},t.autoID=0,t}(),PositionC=function(){function t(t,e){this.name="pos",this.x=t,this.y=e}return t}(),AABBC=function(){function t(t,e){this.name="aabb",this.w=t,this.h=e}return t}(),SpriteC=function(){function t(t){this.name="sprite",this.redraw=!0,this.visable=!0,this.image=t}return t}(),LevelC=function(){function t(t){this.name="level",this.level=t}return t}(),AudioC=function(){function t(t){this.name="audio",this.sound=new AudioPool(t,3)}return t}(),MovementC=function(){function t(){this.name="mv",this.x=0,this.y=0}return t}(),CollisionTypes;!function(t){t[t.ENTITY=0]="ENTITY",t[t.LEVEL=1]="LEVEL",t[t.WORLD=2]="WORLD"}(CollisionTypes||(CollisionTypes={}));var CollisionC=function(){function t(t){void 0===t&&(t=CollisionTypes.LEVEL),this.name="collision",this.type=t}return t}(),PlayerC=function(){function t(){this.name="player",this.value=!0}return t}(),AIHeroC=function(){function t(t){void 0===t&&(t=[]),this.name="aihero",this.movementCooldown=5e3,this.value=!0,this.pathReady=!0,this.AIPath=t}return t}(),BossC=function(){function t(){this.name="boss",this.value=!0}return t}(),CombatC=function(){function t(){this.name="combat",this.alive=!0}return t}(),InputC=function(){function t(t){void 0===t&&(t=!0),this.name="input",this.enabled=!0,this.cooldowns=[],this.enabled=t,this.cooldowns[0]=this.cooldowns[1]=this.cooldowns[2]=this.cooldowns[3]=0}return t}(),HauntC=function(){function t(){this.name="haunt",this.haunting=!1}return t}(),XPC=function(){function t(t){void 0===t&&(t=0),this.name="xp",this.value=0,this.value=t}return t}(),LVLC=function(){function t(t){void 0===t&&(t=1),this.name="lvl",this.value=t}return t}(),HPC=function(){function t(t){void 0===t&&(t=5),this.name="hp",this.value=t}return t}(),Game=function(){function t(t){this.entities=[],this.change=!0,this.redraw=!0,this.clearScreen=!0,this.then=performance.now(),this.timePaused=0,this.deltaPaused=0,console.log("Setting up screen"),this.screen=t,this.ctx=t.getContext("2d"),this.ctx.mozImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1}return t.prototype.makeGEntity=function(t,e,i,n){var s=new Entity;return s.add(new PositionC(t,e)),s.add(new AABBC(8,8)),s.add(new MovementC),s.add(new CollisionC(n)),s.add(new LevelC(this.World)),s.add(new SpriteC(i)),s},t.prototype.init=function(){console.log("Initializing..."),SSC.storeSheet(new SpriteSheet("sheet","pieces",8,0,new Dm(5,1))),SSC.storeSheet(new SpriteSheet("sheet","board",8,0,new Dm(5,1),new Pt(40,0))),SSC.storeSheet(new SpriteSheet("sheet","numbers",8,0,new Dm(10,1),new Pt(0,8))),SSC.storeSheet(new SpriteSheet("sheet","alpha",8,0,new Dm(10,3),new Pt(0,16))),Level.defaultTileSet=new TileSet(SSC.spriteSheet("board")),this.World=new Level;var t=this.pEntity=this.makeGEntity(1,1,SSC.spriteSheet("pieces").sprites[0],CollisionTypes.WORLD);t.add(new InputC(!0)),t.add(new HauntC),t.add(new PlayerC),t.add(new AudioC("gblip.wav")),this.World.entities.push(t);var t=this.hEntity=this.makeGEntity(1,this.World.map.size.height-2,SSC.spriteSheet("pieces").sprites[1],CollisionTypes.ENTITY);t.add(new AudioC("hstep.wav")),t.add(new CombatC),t.add(new AIHeroC(this.World.AIPath)),this.World.entities.push(t);for(var e=0;5>e;e++){var i=this.World.eSpawns.splice(getRandomInt(0,this.World.eSpawns.length-1),1)[0],t=this.makeGEntity(i.x,i.y,SSC.spriteSheet("pieces").sprites[2],CollisionTypes.ENTITY);t.add(new InputC(!1)),t.add(new CombatC),t.add(new AudioC("gblip.wav")),this.World.entities.push(t)}for(var e=0;5>e;e++){var i=this.World.eSpawns.splice(getRandomInt(0,this.World.eSpawns.length-1),1)[0],t=this.makeGEntity(i.x,i.y,SSC.spriteSheet("pieces").sprites[3],CollisionTypes.ENTITY);t.add(new InputC(!1)),t.add(new CombatC),t.add(new AudioC("gblip.wav")),this.World.entities.push(t)}var t=this.makeGEntity(23,1,SSC.spriteSheet("pieces").sprites[4],CollisionTypes.ENTITY);t.add(new BossC),this.World.entities.push(t),this.state="MainMenu"},t.prototype.update=function(t){switch(this.state){case"MainMenu":this.state="GameMaze";break;case"GameMaze":this.deltaPaused>0&&(t-=this.deltaPaused,0>t&&(t=0),this.deltaPaused=0);for(var e=0,i=this.World.entities;e<i.length;e++){var n=i[e];combat(n),AIMovement(n,t),input(n,t),haunt(n),!n.mv||0==n.mv.x&&0==n.mv.y||collision(n),movementSound(n),movement(n)}break;case"GamePause":break;case"GameOver":this.state="MainMenu"}},t.prototype.draw=function(){switch(this.state){case"MainMenu":break;case"GameMaze":this.clearScreen&&(this.ctx.clearRect(0,0,this.screen.width,this.screen.height),this.clearScreen=!1);for(var t=0,e=this.entities;t<e.length;t++){var i=e[t];i.sprite.redraw&&draw(this.ctx,i)}for(var n=0,s=this.World.entities;n<s.length;n++){var i=s[n];i.sprite&&i.sprite.redraw===!0&&(this.redraw=!0)}if(this.redraw||this.change){this.World.map.draw(this.ctx);for(var o=0,a=this.World.entities;o<a.length;o++){var i=a[o];draw(this.ctx,i)}draw(this.ctx,this.pEntity),this.change=!1,this.redraw=!1}break;case"GamePause":this.change&&(this.ctx.globalAlpha=.7,this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.screen.width,this.screen.height),this.ctx.globalAlpha=1,this.ctx.font="18px Verdana",this.ctx.textAlign="center",this.ctx.fillStyle="white",this.ctx.fillText("PAUSED",this.screen.width/2|0,this.screen.height/2|0),this.change=!1);break;case"GameOver":}},t.prototype.render=function(){var t=performance.now(),e=t-this.then;this.then=t,this.update(e),this.draw(),this._loopHandle=window.requestAnimationFrame(this.render.bind(this))},t.prototype.run=function(){console.log("Game running"),this._loopHandle=window.requestAnimationFrame(this.render.bind(this))},t.prototype.stop=function(){console.log("Game stopped"),window.cancelAnimationFrame(this._loopHandle)},t.prototype.pause=function(){"GameMaze"===this.state&&(this.state="GamePause",this.change=!0,this.timePaused=performance.now())},t.prototype.unpause=function(){"GamePause"===this.state&&(this.state="GameMaze",this.change=this.clearScreen=!0,this.deltaPaused=performance.now()-this.timePaused,this.timePaused=0)},t}();window.onload=function(){onResize(),window.addEventListener("resize",onResize,!1),window.onkeydown=Input.KB.keyDown,window.onkeyup=Input.KB.keyUp;var t=new Game(document.getElementById("gameCanvas"));ImageCache.Loader.add("sheet","sheet.png"),ImageCache.Loader.load(function(){t.init(),window.onblur=t.pause.bind(t),window.onfocus=t.unpause.bind(t),t.run()})};